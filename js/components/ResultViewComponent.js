// ÁµêÊûúË°®Á§∫„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
export class ResultViewComponent {
    constructor(app) {
        this.app = app;
        this.element = document.getElementById('result-view');
        this.isInitialized = false;
        this.currentScore = null;
        this.currentCharacter = null;
    }

    init() {
        if (this.isInitialized) return;
        
        this.setupEventListeners();
        this.isInitialized = true;
        console.log('ResultViewComponentÂàùÊúüÂåñÂÆå‰∫Ü');
    }

    setupEventListeners() {
        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅØÂãïÁöÑ„Å´ÁîüÊàê„Åï„Çå„Çã„Éú„Çø„É≥„Å´ÂØæ„Åó„Å¶Ë®≠ÂÆö„Åô„Çã„Åü„ÇÅ„ÄÅ
        // „Ç§„Éô„É≥„ÉàÂßîË≠≤„Çí‰ΩøÁî®
        this.element.addEventListener('click', (e) => {
            if (e.target.id === 'try-again-btn') {
                this.handleButtonClick(e, () => this.onTryAgain());
            } else if (e.target.id === 'next-character-btn') {
                this.handleButtonClick(e, () => this.onNextCharacter());
            } else if (e.target.id === 'show-example-btn') {
                this.handleButtonClick(e, () => this.onShowExample());
            } else if (e.target.id === 'back-to-menu-btn') {
                this.handleButtonClick(e, () => this.onBackToMenu());
            }
        });
    }

    render(score, character) {
        this.currentScore = score;
        this.currentCharacter = character;
        
        const scoreData = this.getScoreData(score);
        
        this.element.innerHTML = `
            <div class="result-content">
                <div class="result-header">
                    <div class="practiced-character">
                        <span class="character-label">Á∑¥Áøí„Åó„ÅüÊñáÂ≠ó</span>
                        <span class="character-display">${character}</span>
                    </div>
                </div>
                
                <div class="result-display">
                    <div class="score-animation">
                        <div id="score-icon" class="score-icon ${scoreData.className}">
                            ${scoreData.icon}
                        </div>
                        <div class="score-effects">
                            ${scoreData.effects}
                        </div>
                    </div>
                    <div id="score-message" class="score-message ${scoreData.messageClass}">
                        ${scoreData.message}
                    </div>
                    <div class="encouragement-text">
                        ${scoreData.encouragement}
                    </div>
                </div>
                
                <div class="result-controls">
                    <div class="primary-actions">
                        <button id="try-again-btn" class="result-button primary-button">
                            <span class="button-icon">üîÑ</span>
                            „ÇÇ„ÅÜ‰∏ÄÂ∫¶
                        </button>
                        <button id="next-character-btn" class="result-button success-button">
                            <span class="button-icon">‚û°Ô∏è</span>
                            Ê¨°„ÅÆÊñáÂ≠ó
                        </button>
                    </div>
                    <div class="secondary-actions">
                        ${score.level === 'poor' || score.level === 'fair' ? 
                            '<button id="show-example-btn" class="result-button help-button"><span class="button-icon">üëÄ</span>ÊâãÊú¨„ÇíË¶ã„Çã</button>' : 
                            ''
                        }
                        <button id="back-to-menu-btn" class="result-button menu-button">
                            <span class="button-icon">üè†</span>
                            „É°„Éã„É•„Éº„Å´Êàª„Çã
                        </button>
                    </div>
                </div>
            </div>
        `;

        // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂäπÊûú„ÇíËøΩÂä†
        this.addAnimationEffects(scoreData);
        
        console.log('ResultViewComponentÊèèÁîªÂÆå‰∫Ü');
    }

    getScoreData(score) {
        switch (score.level) {
            case 'excellent':
                return {
                    icon: 'üåü',
                    className: 'excellent',
                    message: '„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ',
                    messageClass: 'excellent-message',
                    encouragement: '„Å®„Å¶„ÇÇ‰∏äÊâã„Å´Êõ∏„Åë„Åæ„Åó„ÅüÔºÅ',
                    effects: '‚ú®üéâ‚ú®'
                };
            case 'good':
                return {
                    icon: 'üòä',
                    className: 'good',
                    message: '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ',
                    messageClass: 'good-message',
                    encouragement: '‰∏äÊâã„Å´Êõ∏„Åë„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                    effects: 'üëèüåüüëè'
                };
            case 'fair':
                return {
                    icon: 'üòê',
                    className: 'fair',
                    message: '„ÇÇ„ÅÜÂ∞ë„ÅóÔºÅ',
                    messageClass: 'fair-message',
                    encouragement: '„ÅÇ„Å®Â∞ë„Åó„Åß‰∏äÊâã„Å´„Å™„Çä„Åæ„ÅôÔºÅ',
                    effects: 'üí™üìùüí™'
                };
            case 'poor':
                return {
                    icon: 'üòÖ',
                    className: 'poor',
                    message: '„Åå„Çì„Å∞„Çç„ÅÜÔºÅ',
                    messageClass: 'poor-message',
                    encouragement: 'Á∑¥Áøí„Åô„Çå„Å∞„Åç„Å£„Å®‰∏äÊâã„Å´„Å™„Çä„Åæ„ÅôÔºÅ',
                    effects: 'üå±üìöüå±'
                };
            default:
                return {
                    icon: 'üòä',
                    className: 'good',
                    message: '„Çà„Åè„Åß„Åç„Åæ„Åó„ÅüÔºÅ',
                    messageClass: 'good-message',
                    encouragement: '‰∏äÊâã„Å´Êõ∏„Åë„Å¶„ÅÑ„Åæ„ÅôÔºÅ',
                    effects: 'üëèüåüüëè'
                };
        }
    }

    addAnimationEffects(scoreData) {
        // „Çπ„Ç≥„Ç¢„Ç¢„Ç§„Ç≥„É≥„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const scoreIcon = this.element.querySelector('#score-icon');
        if (scoreIcon) {
            setTimeout(() => {
                scoreIcon.classList.add('animate-in');
            }, 100);
        }

        // „Ç®„Éï„Çß„ÇØ„Éà„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const effects = this.element.querySelector('.score-effects');
        if (effects) {
            setTimeout(() => {
                effects.classList.add('animate-effects');
            }, 300);
        }

        // „É°„ÉÉ„Çª„Éº„Ç∏„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        const message = this.element.querySelector('#score-message');
        if (message) {
            setTimeout(() => {
                message.classList.add('animate-message');
            }, 500);
        }

        // Èü≥Â£∞„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
        this.playResultSound(scoreData.className);
    }

    playResultSound(scoreClass) {
        try {
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            // „Çπ„Ç≥„Ç¢„Å´Âøú„Åò„Å¶Áï∞„Å™„ÇãÈü≥„ÇíÂÜçÁîü
            let frequency, duration;
            switch (scoreClass) {
                case 'excellent':
                    frequency = 880; // A5
                    duration = 0.6;
                    break;
                case 'good':
                    frequency = 660; // E5
                    duration = 0.4;
                    break;
                case 'fair':
                    frequency = 440; // A4
                    duration = 0.3;
                    break;
                case 'poor':
                    frequency = 330; // E4
                    duration = 0.2;
                    break;
                default:
                    frequency = 660;
                    duration = 0.4;
            }
            
            oscillator.frequency.setValueAtTime(frequency, audioContext.currentTime);
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        } catch (error) {
            console.log('Èü≥Â£∞„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„Çí„Çπ„Ç≠„ÉÉ„Éó');
        }
    }

    handleButtonClick(event, callback) {
        const button = event.target.closest('.result-button');
        if (button) {
            button.classList.add('clicked');
            setTimeout(() => {
                button.classList.remove('clicked');
                callback();
            }, 200);
        } else {
            callback();
        }
    }

    displayResult(score, character) {
        this.render(score, character);
        
        // ÁîªÈù¢Ë°®Á§∫ÊôÇ„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥
        this.element.classList.add('result-enter');
        setTimeout(() => {
            this.element.classList.remove('result-enter');
        }, 600);
        
        console.log(`ÁµêÊûúË°®Á§∫: ${character} - „Çπ„Ç≥„Ç¢: ${score.level}`);
    }

    onTryAgain() {
        console.log('„ÇÇ„ÅÜ‰∏ÄÂ∫¶ÊåëÊà¶');
        this.addExitAnimation(() => {
            this.app.tryAgain();
        });
    }

    onNextCharacter() {
        console.log('Ê¨°„ÅÆÊñáÂ≠ó„Å∏');
        this.addExitAnimation(() => {
            this.app.nextCharacter();
        });
    }

    onShowExample() {
        console.log('ÊâãÊú¨„ÇíË°®Á§∫');
        this.addExitAnimation(() => {
            this.app.showExample();
        });
    }

    onBackToMenu() {
        console.log('„É°„Éã„É•„Éº„Å´Êàª„Çã');
        this.addExitAnimation(() => {
            this.app.showScreen('main-menu');
        });
    }

    addExitAnimation(callback) {
        this.element.classList.add('result-exit');
        setTimeout(() => {
            this.element.classList.remove('result-exit');
            callback();
        }, 300);
    }

    // Â§ñÈÉ®„Åã„ÇâÂëº„Å≥Âá∫„Åï„Çå„ÇãË°®Á§∫„É°„ÇΩ„ÉÉ„Éâ
    show(score, character) {
        this.displayResult(score, character);
    }
}